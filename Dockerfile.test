# Dockerfile for pycmor testing environment
# Debian slim with system packages for NetCDF/HDF5

ARG PYTHON_VERSION=3.11
FROM python:${PYTHON_VERSION}-slim

# Install system dependencies including HDF5 and NetCDF libraries
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    libhdf5-dev \
    libnetcdf-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy requirements first for better caching
COPY pyproject.toml versioneer.py ./
COPY src/pycmor/_version.py src/pycmor/_version.py

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip wheel setuptools

# Copy the rest of the code
COPY . .

# Install pycmor with dev dependencies
RUN pip install --no-cache-dir ".[dev, fesom]"

# Set environment variables for testing
ENV PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300
ENV PYTHONUNBUFFERED=1
ENV HDF5_USE_FILE_LOCKING=FALSE

# Verify installation
RUN python -c "import h5py; print('h5py version:', h5py.__version__); print('HDF5 version:', h5py.version.hdf5_version)"

# Default command runs tests
CMD ["pytest", "-vvv", "--cov=src/pycmor", "tests/"]
