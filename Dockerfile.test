# Dockerfile for pycmor testing environment
# Builds a stable environment with compatible versions of h5netcdf, h5py, and HDF5

FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    libhdf5-dev \
    libnetcdf-dev \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy requirements first for better caching
COPY setup.py setup.cfg versioneer.py ./
COPY src/pycmor/_version.py src/pycmor/_version.py

# Install Python dependencies
# Install package with dev and fesom extras
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir wheel setuptools

# Copy the rest of the code
COPY . .

# Install pycmor with all test dependencies
RUN pip install --no-cache-dir ".[dev,fesom]"

# Set environment variables for testing
ENV XARRAY_ENGINE=h5netcdf
ENV PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300
ENV PYCMOR_XARRAY_PARALLEL=no
ENV PYTHONUNBUFFERED=1

# Default command runs tests
CMD ["pytest", "-vvv", "--cov=src/pycmor", "tests/"]
